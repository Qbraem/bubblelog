<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BubbleLog</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import {
      getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword,
      onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, serverTimestamp,
      query, orderBy, getDocs
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCX7hc6IofjuJWUT2M11GkYRnD-XRfwmjA",
      authDomain: "bubblelog-2933c.firebaseapp.com",
      projectId: "bubblelog-2933c",
      storageBucket: "bubblelog-2933c.firebasestorage.app",
      messagingSenderId: "81946623882",
      appId: "1:81946623882:web:4951374508e62697771273",
      measurementId: "G-2ZKKPC8T6M"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const authContainer = document.getElementById("auth-container");
    const toggleLink = document.getElementById("toggle-link");
    const authForm = document.getElementById("auth-form");
    const waterForm = document.getElementById("waterForm");
    const logoutBtn = document.getElementById("logout-btn");
    const historySection = document.getElementById("history-section");
    const chartCanvas = document.getElementById("chart");

    let isLogin = true;
    toggleLink.addEventListener("click", () => {
      isLogin = !isLogin;
      document.getElementById("auth-title").textContent = isLogin ? "Login" : "Register";
      document.getElementById("auth-submit").textContent = isLogin ? "Login" : "Register";
      toggleLink.textContent = isLogin ? "Don't have an account? Register" : "Already have an account? Login";
    });

    authForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = authForm.email.value;
      const password = authForm.password.value;
      try {
        if (isLogin) {
          await signInWithEmailAndPassword(auth, email, password);
        } else {
          await createUserWithEmailAndPassword(auth, email, password);
        }
      } catch (err) {
        alert(err.message);
      }
    });

    logoutBtn.addEventListener("click", () => signOut(auth));

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        authContainer.classList.add("hidden");
        waterForm.classList.remove("hidden");
        logoutBtn.classList.remove("hidden");
        historySection.classList.remove("hidden");
        await loadHistory(user.uid);
      } else {
        authContainer.classList.remove("hidden");
        waterForm.classList.add("hidden");
        logoutBtn.classList.add("hidden");
        historySection.classList.add("hidden");
      }
    });

    waterForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const user = auth.currentUser;
      if (!user) return;

      const data = {
        ph: parseFloat(waterForm.ph.value),
        kh: parseFloat(waterForm.kh.value),
        gh: parseFloat(waterForm.gh.value),
        cl: parseFloat(waterForm.cl.value),
        no2: parseFloat(waterForm.no2.value),
        no3: parseFloat(waterForm.no3.value),
        co2: calculateCO2(parseFloat(waterForm.ph.value), parseFloat(waterForm.kh.value)),
        timestamp: serverTimestamp()
      };

      try {
        await addDoc(collection(db, "users", user.uid, "entries"), data);
        alert("Entry saved successfully.");
        waterForm.reset();
        document.getElementById('co2').value = '';
        await loadHistory(user.uid);
      } catch (error) {
        console.error("Error saving entry: ", error);
        alert("Failed to save entry.");
      }
    });

    const phInput = document.getElementById('ph');
    const khInput = document.getElementById('kh');
    const co2Output = document.getElementById('co2');

    function calculateCO2(ph, kh) {
      return (3 * kh * Math.pow(10, (7 - ph))).toFixed(2);
    }

    function updateCO2() {
      const ph = parseFloat(phInput.value);
      const kh = parseFloat(khInput.value);
      if (!isNaN(ph) && !isNaN(kh)) {
        co2Output.value = calculateCO2(ph, kh) + ' mg/l';
      } else {
        co2Output.value = '';
      }
    }

    async function loadHistory(uid) {
      const q = query(collection(db, "users", uid, "entries"), orderBy("timestamp", "desc"));
      const querySnapshot = await getDocs(q);
      const labels = [];
      const phData = [];
      const co2Data = [];
      let latestEntry = null;

      querySnapshot.forEach((doc, index) => {
        const entry = doc.data();
        const date = entry.timestamp?.toDate().toLocaleDateString() || 'Unknown';
        labels.push(date);
        phData.push(entry.ph);
        co2Data.push(entry.co2);
        if (index === 0) latestEntry = entry;
      });

      renderChart(labels.reverse(), phData.reverse(), co2Data.reverse());
      renderAdvice(latestEntry);
    }

    function renderChart(labels, phData, co2Data) {
      new Chart(chartCanvas, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: 'pH',
              data: phData,
              borderColor: 'rgb(59, 130, 246)',
              fill: false
            },
            {
              label: 'CO₂ (mg/l)',
              data: co2Data,
              borderColor: 'rgb(16, 185, 129)',
              fill: false
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'bottom' },
            title: { display: true, text: 'Water Parameter History' }
          }
        }
      });
    }

    function renderAdvice(entry) {
      const adviceEl = document.getElementById("water-advice");
      if (!entry) {
        adviceEl.textContent = "No recent data available for advice.";
        return;
      }

      const { ph, co2, cl, no2, no3 } = entry;
      let advice = [];

      if (ph < 6.5) advice.push("pH is low. Consider buffering your water.");
      else if (ph > 7.5) advice.push("pH is high. Consider using driftwood or CO₂ injection.");
      else advice.push("pH level looks good.");

      if (co2 < 15) advice.push("CO₂ is quite low. Your plants may benefit from more CO₂.");
      else if (co2 > 35) advice.push("CO₂ is very high. Watch out for livestock stress.");
      else advice.push("CO₂ levels are within an ideal range.");

      if (cl > 0) advice.push("Chlorine detected. Use a water conditioner.");
      if (no2 > 0.1) advice.push("Nitrites are elevated. Check your filtration.");
      if (no3 > 40) advice.push("Nitrates are high. Consider a water change.");

      adviceEl.innerHTML = advice.map(a => `<li>${a}</li>`).join('');
    }

    phInput.addEventListener('input', updateCO2);
    khInput.addEventListener('input', updateCO2);
  </script>
</head>
<body class="bg-gray-50 text-gray-900 font-sans">
  <div class="max-w-md mx-auto p-4">
    <h1 class="text-3xl font-bold mb-6 text-center">BubbleLog</h1>

    <div id="auth-container" class="bg-white p-6 rounded-xl shadow mb-6">
      <h2 id="auth-title" class="text-xl font-semibold mb-4">Login</h2>
      <form id="auth-form" class="grid gap-4">
        <div>
          <label class="block text-sm font-medium">Email</label>
          <input type="email" name="email" class="w-full border rounded p-2" required />
        </div>
        <div>
          <label class="block text-sm font-medium">Password</label>
          <input type="password" name="password" class="w-full border rounded p-2" required />
        </div>
        <button id="auth-submit" type="submit" class="bg-blue-600 text-white p-2 rounded hover:bg-blue-700">Login</button>
        <p class="text-sm text-center text-blue-600 cursor-pointer" id="toggle-link">Don't have an account? Register</p>
      </form>
    </div>

    <form id="waterForm" class="bg-white p-6 rounded-xl shadow hidden">
      <div class="grid gap-4">
        <div><label class="block text-sm font-medium">pH</label><input type="number" step="0.1" name="ph" id="ph" class="w-full border rounded p-2" required /></div>
        <div><label class="block text-sm font-medium">KH</label><input type="number" step="0.1" name="kh" id="kh" class="w-full border rounded p-2" required /></div>
        <div><label class="block text-sm font-medium">GH</label><input type="number" step="0.1" name="gh" id="gh" class="w-full border rounded p-2" /></div>
        <div><label class="block text-sm font-medium">Chlorine (Cl)</label><input type="number" step="0.1" name="cl" id="cl" class="w-full border rounded p-2" /></div>
        <div><label class="block text-sm font-medium">Nitrites (NO2)</label><input type="number" step="0.1" name="no2" id="no2" class="w-full border rounded p-2" /></div>
        <div><label class="block text-sm font-medium">Nitrates (NO3)</label><input type="number" step="0.1" name="no3" id="no3" class="w-full border rounded p-2" /></div>
        <div><label class="block text-sm font-medium">CO₂ (calculated)</label><input type="text" id="co2" class="w-full border rounded p-2 bg-gray-100" readonly /></div>
      </div>
      <button type="submit" class="mt-6 w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-700">Save Entry</button>
    </form>

    <div id="history-section" class="hidden mt-8">
      <h2 class="text-xl font-semibold mb-4 text-center">History & Analytics</h2>
      <canvas id="chart" class="w-full h-64 mb-6"></canvas>
      <h3 class="text-lg font-medium mb-2">Water Quality Advice</h3>
      <ul id="water-advice" class="text-sm list-disc pl-5 space-y-1"></ul>
    </div>

    <button id="logout-btn" class="hidden mt-4 w-full text-sm text-center text-blue-600 hover:underline">Logout</button>
  </div>
</body>
</html>
